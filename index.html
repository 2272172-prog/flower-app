<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Flower Shop ULTRA</title>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#fff0f5}
header{display:flex;justify-content:space-between;padding:15px;background:white;box-shadow:0 2px 8px rgba(0,0,0,.05)}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:20px;padding:20px}
.card{background:white;border-radius:16px;box-shadow:0 4px 15px rgba(0,0,0,.08);overflow:hidden}
.card img{width:100%;height:200px;object-fit:cover}
.card div{padding:15px}
button{border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
.primary{background:#e91e63;color:white}
.cart{position:fixed;right:20px;bottom:20px;background:white;padding:15px;border-radius:16px;box-shadow:0 5px 20px rgba(0,0,0,.2);width:300px;max-height:400px;overflow:auto}
input{padding:8px;border-radius:8px;border:1px solid #ddd;margin-bottom:8px;width:100%}
</style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "–¢–í–û–ô_API_KEY",
  authDomain: "flower-app-5a32c.firebaseapp.com",
  projectId: "flower-app-5a32c",
  storageBucket: "flower-app-5a32c.appspot.com"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

const { useState, useEffect } = React;

function App() {
  const [flowers,setFlowers]=useState([]);
  const [cart,setCart]=useState(JSON.parse(localStorage.getItem("cart"))||[]);
  const [user,setUser]=useState(null);
  const [orders,setOrders]=useState([]);

  useEffect(()=>{
    onSnapshot(collection(db,"flowers"),snap=>{
      setFlowers(snap.docs.map(d=>({...d.data(),id:d.id})));
    });
  },[]);

  useEffect(()=>{
    localStorage.setItem("cart",JSON.stringify(cart));
  },[cart]);

  useEffect(()=>{
    onAuthStateChanged(auth,u=>{
      setUser(u);
      if(u){
        const q=query(collection(db,"orders"),where("userId","==",u.uid));
        onSnapshot(q,snap=>{
          setOrders(snap.docs.map(d=>d.data()));
        });
      }
    });
  },[]);

  const addToCart=f=>setCart([...cart,f]);
  const removeFromCart=i=>setCart(cart.filter((_,idx)=>idx!==i));

  const login=async()=>{
    const email=prompt("Email");
    const pass=prompt("Password");
    await signInWithEmailAndPassword(auth,email,pass);
  };

  const checkout=async()=>{
    if(!user) return alert("–í–æ–π–¥–∏");
    const total=cart.reduce((s,i)=>s+i.price,0);
    await addDoc(collection(db,"orders"),{
      userId:user.uid,
      items:cart,
      total,
      createdAt:new Date()
    });
    setCart([]);
  };

  const uploadFlower=async()=>{
    if(!user) return;
    const name=prompt("–ù–∞–∑–≤–∞–Ω–∏–µ");
    const price=Number(prompt("–¶–µ–Ω–∞"));
    const input=document.createElement("input");
    input.type="file";
    input.onchange=async e=>{
      const file=e.target.files[0];
      const imageRef=ref(storage,"flowers/"+Date.now());
      await uploadBytes(imageRef,file);
      const url=await getDownloadURL(imageRef);

      await addDoc(collection(db,"flowers"),{
        name,price,image:url
      });
    };
    input.click();
  };

  return (
    <>
      <header>
        <h2>üå∏ Flower ULTRA</h2>
        <div>
          {!user && <button onClick={login}>–í–æ–π—Ç–∏</button>}
          {user && <button className="primary" onClick={uploadFlower}>–î–æ–±–∞–≤–∏—Ç—å</button>}
        </div>
      </header>

      <div className="grid">
        {flowers.map(f=>(
          <div className="card" key={f.id}>
            <img src={f.image}/>
            <div>
              <h3>{f.name}</h3>
              <p>{f.price} ‚ÇΩ</p>
              <button className="primary" onClick={()=>addToCart(f)}>–í –∫–æ—Ä–∑–∏–Ω—É</button>
            </div>
          </div>
        ))}
      </div>

      <div className="cart">
        <h3>–ö–æ—Ä–∑–∏–Ω–∞</h3>
        {cart.map((c,i)=>(
          <div key={i}>
            {c.name} ‚Äî {c.price} ‚ÇΩ
            <button onClick={()=>removeFromCart(i)}>‚ùå</button>
          </div>
        ))}
        <hr/>
        <b>–ò—Ç–æ–≥–æ: {cart.reduce((s,i)=>s+i.price,0)} ‚ÇΩ</b>
        <br/><br/>
        <button className="primary" onClick={checkout}>–û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>

      {user && (
        <div style={{padding:"20px"}}>
          <h3>–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h3>
          {orders.map((o,i)=>(
            <div key={i}>
              –°—É–º–º–∞: {o.total} ‚ÇΩ | –¢–æ–≤–∞—Ä–æ–≤: {o.items.length}
            </div>
          ))}
        </div>
      )}
    </>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);

if("serviceWorker" in navigator){
  const swBlob = new Blob([`
    self.addEventListener('install', e=>self.skipWaiting());
    self.addEventListener('fetch', e=>{});
  `], { type: 'text/javascript' });

  navigator.serviceWorker.register(URL.createObjectURL(swBlob));
}

</script>

</body>
</html>
